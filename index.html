<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カード画像ジェネレーター</title>
  <style>
    body { 
      font-family: "Hiragino Sans", "Meiryo", sans-serif; 
      padding: 2em; 
      max-width: 1400px;
      margin: 0 auto;
      background-color: #f5f5f5;
    }
    h1, h2 { color: #333; }
    .container {
      background-color: white;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .controls {
      margin-bottom: 2em;
      padding: 1em;
      background-color: #f0f8ff;
      border-radius: 8px;
    }
    .control-group {
      margin-bottom: 1em;
    }
    label {
      display: block;
      margin-bottom: 0.5em;
      font-weight: bold;
    }
    .inline-label {
      display: inline-block;
      margin-right: 1em;
    }
    canvas { 
      border: 1px solid #ccc; 
      display: block; 
      margin: 1em 0; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #cardList { 
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 1.5em; 
      margin-top: 2em;
    }
    .cardWrapper { 
      display: flex; 
      flex-direction: column; 
      align-items: center;
      background-color: white;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card-preview {
      width: 100%;
      height: auto;
      max-width: 240px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5em;
      font-size: 14px;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .button-group {
      display: flex;
      justify-content: center;
      margin-top: 1em;
    }
    .download-all {
      background-color: #2196F3;
      margin-top: 1em;
    }
    input[type="color"] {
      width: 50px;
      height: 30px;
      cursor: pointer;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }
    .info {
      background-color: #e7f3fe;
      border-left: 6px solid #2196F3;
      padding: 0.5em 1em;
      margin-bottom: 1em;
    }
    .csv-preview {
      margin-top: 1em;
      padding: 1em;
      background-color: #f9f9f9;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>カード画像ジェネレーター</h1>
      <div>
        <button id="resetBtn">リセット</button>
      </div>
    </div>
    
    <div class="info">
      <p>カードサイズ: 480x720px（ccfoliaのグリッド4x6に最適化）</p>
    </div>

    <div class="controls">
      <h2>CSVファイルアップロード</h2>
      <p>1列目がタイトル、2列目以降が本文として使用される任意のCSVファイルをアップロードしてください。</p>
      <p><strong>重要:</strong> CSVファイルの1行目はヘッダー行として認識され、カードデータには含まれません。実際のカードは2行目以降のデータから生成されます。</p>
      <div class="control-group">
        <label for="csvInput">CSVファイルを選択:</label>
        <input type="file" id="csvInput" accept=".csv">
        <div style="margin-top: 0.5em; font-size: 12px; color: #666;">
          新しいCSVファイルを選択すると、既存のカードは自動的に新しい内容に更新されます
        </div>
      </div>

      <div id="csvPreview" class="csv-preview">
        <p>CSVプレビューがここに表示されます</p>
      </div>
      
      <h2>カードデザイン</h2>
      <div class="control-group">
        <label>カードデザイン:</label>
        <div>
          <label class="inline-label">背景色: <input type="color" id="bgColor" value="#ffffff"></label>
          <label class="inline-label">枠線色: <input type="color" id="borderColor" value="#000000"></label>
          <label class="inline-label">タイトル色: <input type="color" id="titleColor" value="#000000"></label>
          <label class="inline-label">テキスト色: <input type="color" id="textColor" value="#000000"></label>
        </div>
      </div>
      
      <div class="control-group">
        <label>フォント設定:</label>
        <div>
          <label>タイトルサイズ: <input type="range" id="titleSize" min="16" max="64" value="54"> <span id="titleSizeValue">54px</span></label>
          <label>テキストサイズ: <input type="range" id="textSize" min="12" max="54" value="40"> <span id="textSizeValue">40px</span></label>
        </div>
      </div>
    </div>
    
    <div class="button-group">
      <button id="downloadAllBtn" class="download-all" disabled>すべてダウンロード (ZIP)</button>
    </div>
    
    <h2>カードプレビュー</h2>
    <div id="cardList"></div>
  </div>
  <div class="info">
    <p>このミニアプリはChatGPT, Claude, Copilot, そして手作業で作られています。</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    // 要素の参照を取得
    const csvInput = document.getElementById('csvInput');
    const cardList = document.getElementById('cardList');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const resetBtn = document.getElementById('resetBtn');
    const bgColor = document.getElementById('bgColor');
    const borderColor = document.getElementById('borderColor');
    const titleColor = document.getElementById('titleColor');
    const textColor = document.getElementById('textColor');
    const titleSize = document.getElementById('titleSize');
    const textSize = document.getElementById('textSize');
    const titleSizeValue = document.getElementById('titleSizeValue');
    const textSizeValue = document.getElementById('textSizeValue');
    const csvPreview = document.getElementById('csvPreview');
    
    // カード生成用データ
    let cardData = [];
    let rawCsvData = [];
    
    // カードの実際のサイズ定義
    const CARD_WIDTH = 480;
    const CARD_HEIGHT = 720;
    
    // イベントリスナーの設定
    csvInput.addEventListener('change', handleFileUpload);
    downloadAllBtn.addEventListener('click', downloadAllCards);
    resetBtn.addEventListener('click', resetApp);
    
    // デザイン設定の変更時に再レンダリング
    [bgColor, borderColor, titleColor, textColor, titleSize, textSize].forEach(elem => {
      elem.addEventListener('input', () => {
        if (elem === titleSize) titleSizeValue.textContent = `${elem.value}px`;
        if (elem === textSize) textSizeValue.textContent = `${elem.value}px`;
        if (cardData.length > 0) generateCards(cardData);
      });
    });
    
    // CSVファイルの処理
    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) {
        // ファイルが選択されていない場合（リセットされた場合）
        resetCardData();
        return;
      }
      
      // 新しいファイルが選択された場合、既存のカードをクリア
      clearExistingCards();
      
      // ローディング状態を表示
      showLoadingState();
      
      Papa.parse(file, {
        header: false, // 配列形式で取得
        skipEmptyLines: true,
        complete: (results) => {
          console.log('PapaParseの結果:', results);
          console.log('メタ情報:', results.meta);
          console.log('全行のデータ:', results.data);
          
          if (results.data && results.data.length > 0) {
            rawCsvData = results.data;
            
            // CSVプレビューを表示
            displayCsvPreview(results.data);
            
            // カードデータに変換
            convertToCardData();
            
            // 成功メッセージを表示
            showSuccessMessage(file.name);
          } else {
            alert('CSVファイルにデータが見つかりませんでした。');
            resetCardData();
          }
          
          // ローディング状態を解除
          hideLoadingState();
        },
        error: (error) => {
          alert('CSVファイルの解析中にエラーが発生しました: ' + error);
          resetCardData();
          hideLoadingState();
        }
      });
    }
    
    // CSVプレビューを表示
    function displayCsvPreview(data) {
      if (data.length === 0) return;
      
      // 最初の行をヘッダーとして扱う
      const headers = data[0] || [];
      const dataRows = data.slice(1);
      
      // 列の情報を表示
      let infoHtml = `<div style="margin-bottom: 10px; padding: 5px; background-color: #e8f4fd; border-radius: 3px;">`;
      infoHtml += `<strong>検出された列:</strong> ${headers.length}列<br>`;
      infoHtml += `<strong>タイトル列:</strong> ${headers[0] || '(空の列名)'}<br>`;
      if (headers.length > 1) {
        const textColumns = headers.slice(1).map((col, index) => col || `列${index + 2}`);
        infoHtml += `<strong>本文列:</strong> ${textColumns.join(', ')}`;
      }
      infoHtml += `<br><strong>データ行数:</strong> ${dataRows.length}行`;
      infoHtml += `</div>`;
      
      // 最大5行まで表示
      const previewData = dataRows.slice(0, 5);
      
      let tableHtml = '<table><thead><tr>';
      headers.forEach((header, index) => {
        const style = index === 0 ? 'background-color: #fff2cc;' : 'background-color: #e8f4fd;';
        const displayName = header || `列${index + 1}`;
        tableHtml += `<th style="${style}">${displayName}</th>`;
      });
      tableHtml += '</tr></thead><tbody>';
      
      previewData.forEach(row => {
        tableHtml += '<tr>';
        // rowは配列形式なので、インデックスでアクセス
        for (let i = 0; i < Math.max(headers.length, row.length); i++) {
          const cellValue = row[i] || '';
          const style = i === 0 ? 'background-color: #fff2cc;' : '';
          const displayValue = cellValue === '' ? '<em>(空)</em>' : cellValue;
          tableHtml += `<td style="${style}">${displayValue}</td>`;
        }
        tableHtml += '</tr>';
      });
      
      tableHtml += '</tbody></table>';
      csvPreview.innerHTML = infoHtml + tableHtml;
    }
    
    // 既存のカードをクリア
    function clearExistingCards() {
      cardList.innerHTML = '';
      cardData = [];
      downloadAllBtn.disabled = true;
    }
    
    // カードデータをリセット
    function resetCardData() {
      cardData = [];
      rawCsvData = [];
      cardList.innerHTML = '';
      csvPreview.innerHTML = '<p>CSVプレビューがここに表示されます</p>';
      downloadAllBtn.disabled = true;
    }
    
    // ローディング状態を表示
    function showLoadingState() {
      csvPreview.innerHTML = '<p style="color: #666; font-style: italic;">CSVファイルを処理中...</p>';
      cardList.innerHTML = '<div style="text-align: center; padding: 2em; color: #666;">カードを生成中...</div>';
    }
    
    // ローディング状態を解除
    function hideLoadingState() {
      // この時点でプレビューとカードは既に更新されているので、特に何もしない
    }
    
    // 成功メッセージを表示
    function showSuccessMessage(fileName) {
      const message = document.createElement('div');
      message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #4CAF50;
        color: white;
        padding: 1em 1.5em;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 14px;
      `;
      message.textContent = `✓ ${fileName} を読み込み、${cardData.length}枚のカードを生成しました`;
      
      document.body.appendChild(message);
      
      // 3秒後に自動で消去
      setTimeout(() => {
        if (message.parentNode) {
          message.parentNode.removeChild(message);
        }
      }, 3000);
    }
    
    // CSVデータをカードデータに変換
    function convertToCardData() {
      if (rawCsvData.length === 0) return;
      
      console.log('=== CSV処理開始 ===');
      console.log('全データ:', rawCsvData);
      
      // 最初の行はヘッダーとして扱い、2行目以降をデータとする
      const headers = rawCsvData[0] || [];
      const dataRows = rawCsvData.slice(1);
      
      console.log('ヘッダー行:', headers);
      console.log('データ行数:', dataRows.length);
      
      if (dataRows.length === 0) {
        alert('CSVファイルにデータ行が見つかりません。');
        return;
      }
      
      // カードデータに変換
      cardData = dataRows.map((row, index) => {
        console.log(`\n--- 行${index + 1}の処理 ---`);
        console.log(`行データ:`, row);
        
        // 1列目をタイトル
        const title = row[0] || '';
        console.log(`タイトル: "${title}"`);
        
        // 2列目以降を本文として結合
        let textParts = [];
        
        for (let i = 1; i < row.length; i++) {
          const content = row[i];
          console.log(`  列${i + 1}: "${content}" (型: ${typeof content})`);
          
          // undefinedやnullでない場合は処理
          if (content !== undefined && content !== null) {
            const trimmedContent = content.toString().trim();
            console.log(`    トリム後: "${trimmedContent}"`);
            // 空文字列でない場合のみ追加
            if (trimmedContent !== '') {
              textParts.push(trimmedContent);
              console.log(`    → 追加しました`);
            } else {
              console.log(`    → 空文字列のためスキップ`);
            }
          } else {
            console.log(`    → undefined/nullのためスキップ`);
          }
        }
        
        console.log(`最終的な本文要素:`, textParts);
        console.log(`結合後の本文: "${textParts.join('\\n')}"`);
        
        return {
          title: title,
          text: textParts.join('\n')
        };
      });
      
      // 空のタイトルの行を除外
      const originalCount = cardData.length;
      cardData = cardData.filter(card => card.title.trim() !== '');
      
      console.log(`\n=== 処理結果 ===`);
      console.log(`処理前のカード数: ${originalCount}`);
      console.log(`生成されたカード数: ${cardData.length}`);
      console.log('最初の3枚のカード:');
      cardData.slice(0, 3).forEach((card, index) => {
        console.log(`  カード${index + 1}: タイトル="${card.title}", 本文="${card.text}"`);
      });
      
      // カード生成
      generateCards(cardData);
      downloadAllBtn.disabled = false;
    }
    
    // カードの生成
    function generateCards(data) {
      cardList.innerHTML = '';
      
      data.forEach((card, i) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'cardWrapper';
        
        // カードを描画するCanvas（フルサイズ）
        const canvas = document.createElement('canvas');
        canvas.width = CARD_WIDTH;
        canvas.height = CARD_HEIGHT;
        canvas.style.display = 'none'; // フルサイズCanvasは非表示
        const ctx = canvas.getContext('2d');
        
        // カードの描画
        drawCard(ctx, canvas, card);
        
        // プレビュー用の小さいCanvas
        const previewCanvas = document.createElement('canvas');
        previewCanvas.className = 'card-preview';
        previewCanvas.width = 240;
        previewCanvas.height = Math.floor(CARD_HEIGHT * (240 / CARD_WIDTH));
        const previewCtx = previewCanvas.getContext('2d');
        
        // フルサイズのカードをプレビューサイズにリサイズ
        previewCtx.drawImage(canvas, 0, 0, CARD_WIDTH, CARD_HEIGHT, 0, 0, previewCanvas.width, previewCanvas.height);
        
        // ダウンロードボタン
        const dlBtn = document.createElement('button');
        dlBtn.textContent = 'ダウンロード';
        dlBtn.onclick = () => downloadCard(canvas, `card_${i + 1}`);
        
        wrapper.appendChild(previewCanvas);
        wrapper.appendChild(dlBtn);
        cardList.appendChild(wrapper);
      });
    }
    
    // カードの描画
    function drawCard(ctx, canvas, card) {
      // 背景
      ctx.fillStyle = bgColor.value;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // 枠線
      ctx.strokeStyle = borderColor.value;
      ctx.lineWidth = 3;
      ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
      
      // タイトル（自動改行対応）
      ctx.fillStyle = titleColor.value;
      ctx.font = `bold ${titleSize.value}px "Hiragino Sans", "Meiryo", sans-serif`;
      ctx.textAlign = 'center';
      const titleLineHeight = parseInt(titleSize.value) * 1.2;
      const titleLines = wrapTextJapaneseCentered(ctx, card.title || '', canvas.width / 2, 80, canvas.width - 60, titleLineHeight);
      
      // タイトルの高さを計算して本文の開始位置を決定
      const titleHeight = titleLines * titleLineHeight;
      const textStartY = Math.max(150, 80 + titleHeight + 30); // 最低150px、またはタイトル終了から30px下
      
      // 説明文
      ctx.fillStyle = textColor.value;
      ctx.font = `${textSize.value}px "Hiragino Sans", "Meiryo", sans-serif`;
      ctx.textAlign = 'left';
      wrapTextJapanese(ctx, card.text || '', 30, textStartY, canvas.width - 60, parseInt(textSize.value) * 1.5);
    }
    
    // 日本語テキストの折り返し処理（中央揃え用）
    function wrapTextJapaneseCentered(ctx, text, x, y, maxWidth, lineHeight) {
      const lines = [];
      let currentLine = '';
      
      // まず改行コードで分割
      const paragraphs = text.split(/\n/);
      
      for (const paragraph of paragraphs) {
        if (paragraph === '') {
          lines.push('');
          continue;
        }
        
        let currentX = 0;
        for (let i = 0; i < paragraph.length; i++) {
          const char = paragraph[i];
          const charWidth = ctx.measureText(char).width;
          
          // 行の最大幅を超える場合は改行
          if (currentX + charWidth > maxWidth) {
            lines.push(currentLine);
            currentLine = char;
            currentX = charWidth;
          } else {
            currentLine += char;
            currentX += charWidth;
          }
        }
        
        // 最後の行を追加
        if (currentLine.length > 0) {
          lines.push(currentLine);
          currentLine = '';
        }
      }
      
      // テキストを中央揃えで描画
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        ctx.fillText(line, x, y + (i * lineHeight));
      }
      
      // 描画した行数を返す
      return lines.length;
    }

    // 日本語テキストの折り返し処理
    function wrapTextJapanese(ctx, text, x, y, maxWidth, lineHeight) {
      // 句読点で改行しないようにする
      const lines = [];
      let currentLine = '';
      
      // まず改行コードで分割
      const paragraphs = text.split(/\n/);
      
      for (const paragraph of paragraphs) {
        if (paragraph === '') {
          lines.push('');
          continue;
        }
        
        // イタリック（斜体）のチェック
        if (paragraph.startsWith('*') && paragraph.endsWith('*')) {
          ctx.save();
          ctx.font = `italic ${textSize.value}px "Hiragino Sans", "Meiryo", sans-serif`;
          lines.push(paragraph);
          ctx.restore();
          continue;
        }
        
        let currentX = x;
        for (let i = 0; i < paragraph.length; i++) {
          const char = paragraph[i];
          const charWidth = ctx.measureText(char).width;
          
          // 行の最大幅を超える場合は改行
          if (currentX + charWidth > x + maxWidth) {
            lines.push(currentLine);
            currentLine = char;
            currentX = x + charWidth;
          } else {
            currentLine += char;
            currentX += charWidth;
          }
        }
        
        // 最後の行を追加
        if (currentLine.length > 0) {
          lines.push(currentLine);
          currentLine = '';
        }
      }
      
      // テキストを描画
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // イタリック（斜体）のチェック
        if (line.startsWith('*') && line.endsWith('*')) {
          ctx.save();
          ctx.font = `italic ${textSize.value}px "Hiragino Sans", "Meiryo", sans-serif`;
          ctx.fillText(line.substring(1, line.length - 1), x, y + (i * lineHeight));
          ctx.restore();
        } else {
          ctx.fillText(line, x, y + (i * lineHeight));
        }
      }
    }
    
    // 個別カードのダウンロード
    function downloadCard(canvas, filename) {
      const link = document.createElement('a');
      link.download = `${filename}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
    
    // すべてのカードをZIPでダウンロード
    function downloadAllCards() {
      if (cardList.children.length === 0) return;
      
      const zip = new JSZip();
      const promises = [];
      
      // カードリストからカードラッパーを取得
      const cardWrappers = Array.from(cardList.children);
      
      // 各カードをZIPに追加
      cardWrappers.forEach((wrapper, i) => {
        // フルサイズのカードを生成
        const canvas = document.createElement('canvas');
        canvas.width = CARD_WIDTH;
        canvas.height = CARD_HEIGHT;
        const ctx = canvas.getContext('2d');
        
        // カードを描画
        drawCard(ctx, canvas, cardData[i]);
        
        const promise = new Promise((resolve) => {
          canvas.toBlob((blob) => {
            zip.file(`card_${i + 1}.png`, blob);
            resolve();
          });
        });
        promises.push(promise);
      });
      
      // すべての処理が完了したらZIPをダウンロード
      Promise.all(promises).then(() => {
        zip.generateAsync({ type: 'blob' }).then((content) => {
          saveAs(content, 'cards.zip');
        });
      });
    }
    
    // アプリケーションのリセット
    function resetApp() {
      csvInput.value = '';
      resetCardData();
      
      // デザイン設定をデフォルトに戻す
      bgColor.value = '#ffffff';
      borderColor.value = '#000000';
      titleColor.value = '#000000';
      textColor.value = '#000000';
      titleSize.value = 54;
      textSize.value = 40;
      titleSizeValue.textContent = '54px';
      textSizeValue.textContent = '40px';
      
      // リセット完了のメッセージを表示
      showResetMessage();
    }
    
    // リセット完了メッセージを表示
    function showResetMessage() {
      const message = document.createElement('div');
      message.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #2196F3;
        color: white;
        padding: 1em 1.5em;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 14px;
      `;
      message.textContent = '✓ アプリケーションをリセットしました';
      
      document.body.appendChild(message);
      
      // 2秒後に自動で消去
      setTimeout(() => {
        if (message.parentNode) {
          message.parentNode.removeChild(message);
        }
      }, 2000);
    }
  </script>
</body>
</html>